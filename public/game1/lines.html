<!doctype html>
<html>
    <head>
        <title>G</title>
        <style>
            body {
                background-color: #555;
            }
        </style>
        <meta charset="utf-8" />
    </head>
    <body>

        <script src="js/underscore.js"> </script>
        <script src="js/backbone.js"> </script>
        <script src="js/math.js"> </script>
        <script src="js/vec2.js"> </script>
        <script src="js/game.js"> </script>

        <!-- game specific -->
        <script src="entities.js"> </script>
        <script src="particles.js"> </script>
        <script src="bullet.js"> </script>
        <script src="player.js"> </script>

        <script>
            var GameBkg = function(ctx) {
                var GRID_SIZE = 20;

                this.update = function(dt) {
                }

                this.render = function() {
                    var c = ctx;
                    c.translate( -c.width/2, -c.height/2);
                    var ds = c.width/GRID_SIZE;
                    c.strokeStyle= "rgba(0, 100, 0, 1)";
                    c.beginPath();
                    for(var i = 0; i < GRID_SIZE;  ++i) {
                        var x = i*ds ;
                        c.moveTo(x, 0);
                        c.lineTo(x, c.height);
                    }
                    for(var i = 0; i < GRID_SIZE;  ++i) {
                        var y = i*ds;
                        c.moveTo(0, y);
                        c.lineTo(c.width, y);
                    }
                    c.stroke();
                }


            }

            var TestGame = Game.extend({

                players: [],

                init: function() {
                    _.bindAll(this, 'on_new_player', 'render', 'render');
                    this.bkg = new GameBkg(this.create_layer());
                    //this.bkg.render();
                    this.layer = this.create_layer();
                    this.pos = 0;
                    this.bind('newplayer', this.on_new_player);
                },

                on_new_player: function(controller) {
                    this.players.push(new Player(new vec2(0, 0), controller));
                },

                update: function(dt) {
                    _.each(this.players,function(p) { p.update(dt) });
                    entities.update(dt);
                },

                render: function() {
                    // clear layer
                    var game = this;
                    game.layer.clearRect(-this.widthHalf, -this.heightHalf, 2*this.widthHalf, 2*this.heightHalf);
                    _.each(this.players, function(p) { p.render(game.layer) });
                    entities.render(game.layer);
                }
            });
            var g = new TestGame();
            g.start();

            function Controller() {
                this.controls = {
                    left: false,
                    right: false,
                    fire: false
                };
            };

            var c = new Controller();
            local_controller(c);
            g.on_new_player(c);

            function local_controller(c) {
                window.addEventListener('keyup', function(e) {
                    if(e.keyCode == 37) { //left
                        c.controls.left = false;
                    } else if(e.keyCode == 39) { // right
                        c.controls.right= false;
                    } else if(e.keyCode == 32) {
                        c.controls.fire = false;
                    }
                });
                window.addEventListener('keydown', function(e) {
                    if(e.keyCode == 37) { //left
                        c.controls.left = true;
                    } else if(e.keyCode == 39) { // right
                        c.controls.right= true;
                    } else if(e.keyCode == 32) {
                        c.controls.fire = true;
                    }
                });
            }
        </script>
    </body>
</html>

